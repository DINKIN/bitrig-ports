$OpenBSD: patch-libproxy_url_cpp,v 1.2 2013/05/08 16:14:34 ajacoutot Exp $

https://code.google.com/p/libproxy/source/detail?r=870

--- libproxy/url.cpp.orig	Tue Oct 16 13:52:03 2012
+++ libproxy/url.cpp	Wed Jun  5 15:02:26 2013
@@ -46,6 +46,10 @@
 using namespace libproxy;
 using namespace std;
 
+#ifndef WIN32
+static pthread_mutex_t servmtx = PTHREAD_MUTEX_INITIALIZER;
+#endif
+
 // This mime type should be reported by the web server
 #define PAC_MIME_TYPE "application/x-ns-proxy-autoconfig"
 // Fall back to checking for this mime type, which servers often report wrong
@@ -61,7 +65,14 @@ static inline int get_default_port(string scheme) {
 	if (plus != string::npos)
 		scheme = scheme.substr(plus + 1);
 
-	if ((serv = getservbyname(scheme.c_str(), NULL)))
+#ifndef WIN32
+	pthread_mutex_lock(&servmtx);
+#endif
+	serv = getservbyname(scheme.c_str(), NULL);
+#ifndef WIN32
+	pthread_mutex_unlock(&servmtx);
+#endif
+	if (serv)
 		return ntohs(serv->s_port);
 
 	return 0;
@@ -403,6 +414,7 @@ char* url::get_pac() {
 				buffer = NULL;
 			}
 		}
+		close(sock);
 		return buffer;
 	}
 
@@ -496,6 +508,7 @@ char* url::get_pac() {
 
 	// Clean up
 	shutdown(sock, SHUT_RDWR);
+	close(sock);
 	return buffer;
 }
 
